<!-- Meal Plan Details -->
<div class="mt-6 space-y-4">
  <%# Assume that diet_set_plan.diet.diet_sets.first is the chosen set %>
  <h3 class="text-lg font-semibold text-center">ü•ó <%= @diet_set_plan.name %></h3>
  <% if @diet_set_plan.meal_plans.any? %>
    <%# Calculate daily totals %>
    <% daily_totals = @diet_set_plan.meal_plans.sum { |mp| mp.kcal || 0 } %>
    <% daily_protein = @diet_set_plan.meal_plans.sum { |mp| mp.protein || 0 } %>
    <% daily_fat = @diet_set_plan.meal_plans.sum { |mp| mp.fat || 0 } %>
    <% daily_carbs = @diet_set_plan.meal_plans.sum { |mp| mp.carbs || 0 } %>
    <% if daily_totals > 0 || daily_protein > 0 || daily_fat > 0 || daily_carbs > 0 %>
      <div class="p-3 bg-green-50 rounded-lg border border-green-200 mb-4">
        <h4 class="text-sm font-semibold text-green-800 mb-2 text-center">üìä Podsumowanie dnia</h4>
        <div class="flex justify-center gap-4 text-sm">
          <div class="text-center">
            <div class="font-bold text-green-700"><%= daily_totals.round %></div>
            <div class="text-xs text-green-600">kcal</div>
          </div>
          <div class="text-center">
            <div class="font-bold text-green-700"><%= daily_protein.round(1) %></div>
            <div class="text-xs text-green-600">g bia≈Çka</div>
          </div>
          <div class="text-center">
            <div class="font-bold text-green-700"><%= daily_fat.round(1) %></div>
            <div class="text-xs text-green-600">g t≈Çuszczu</div>
          </div>
          <div class="text-center">
            <div class="font-bold text-green-700"><%= daily_carbs.round(1) %></div>
            <div class="text-xs text-green-600">g wƒôglowodan√≥w</div>
          </div>
        </div>
      </div>
    <% end %>
    <% @diet_set_plan.meal_plans.each do |meal_plan| %>
      <!-- Each meal card is clickable and toggles its details using our Stimulus controller -->
      <div class="p-4 bg-white rounded-lg shadow-md cursor-pointer"
            data-controller="toggle-meal"
            data-action="click->toggle-meal#toggle">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <h3 class="text-lg font-semibold"><%= meal_plan.name %></h3>
            <span class="text-sm text-gray-500"><%= meal_time_for(meal_plan) %></span>
            <% if meal_plan.kcal.present? || meal_plan.protein.present? || meal_plan.fat.present? || meal_plan.carbs.present? %>
              <div class="flex gap-3 mt-2 text-xs text-gray-600">
                <% if meal_plan.kcal.present? %>
                  <span><strong><%= meal_plan.kcal %></strong> kcal</span>
                <% end %>
                <% if meal_plan.protein.present? %>
                  <span><strong><%= meal_plan.protein.round(1) %></strong>g bia≈Çka</span>
                <% end %>
                <% if meal_plan.fat.present? %>
                  <span><strong><%= meal_plan.fat.round(1) %></strong>g t≈Çuszczu</span>
                <% end %>
                <% if meal_plan.carbs.present? %>
                  <span><strong><%= meal_plan.carbs.round(1) %></strong>g wƒôglowodan√≥w</span>
                <% end %>
              </div>
            <% end %>
          </div>
          <div id="<%= dom_id(meal_plan, :shopping_bag) %>">
            <%= render partial: "diet_set_plans/shopping_bag_icon", locals: { meal_plan: meal_plan } %>
          </div>
        </div>
        <!-- Details: ingredients and instructions (initially hidden) -->
        <div data-toggle-meal-target="toggle" data-toggle-meal-animation-value="slide" class="hidden mt-2 overflow-hidden">
          <% if meal_plan.instructions.present? %>
            <div class="p-2 text-sm prose bg-gray-100 rounded">
              <%= simple_format(meal_plan.instructions) %>
            </div>
          <% end %>
          <ul class="list-disc">
            <% meal_plan.products.each do |product| %>
                <li class="flex flex-col mt-4">
                <div class="flex items-center justify-between">
                  <div class="ml-3">
                    <p class="text-base font-semibold"><%= product.name %></p>
                  </div>
                  <% if product.ingredient_measures.present? %>
                    <div class="flex-col text-sm text-gray-600 felx">
                      <% product.ingredient_measures.each do |measurement| %>
                        <p class="text-right text-nowrap"><%= (measurement.amount)&.round(2) %> <%= measurement.unit %></p>
                        
                      <% end %>
                    </div>
                  <% end %>
                </div>
                </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>
  <% else %>
    <p class="mt-6 text-center text-gray-500">Brak posi≈Çk√≥w dla wybranego zestawu.</p>
  <% end %>
  <!-- New Set Button (subdued) -->
  <div class="mt-4 mb-12 space-y-2 text-center">
    <div class="flex items-center justify-center space-x-4">
      <%= link_to "Przypisz nowy zestaw", diet_set_plans_path(reassign: true, date: params['date']), class: "text-xs text-gray-400 hover:underline" %>
      <span class="text-gray-300">‚Ä¢</span>
      <button type="button" 
              class="text-xs text-gray-400 hover:underline focus:outline-none"
              data-diet-swap-target="swapButton"
              data-action="click->diet-swap#toggleSwapMode">
        Zamie≈Ñ zestaw diety
      </button>
    </div>
  </div>
</div>
